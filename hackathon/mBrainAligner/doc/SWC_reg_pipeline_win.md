### SWC registration pipeline--windows version

![swc_reg_example_1](https://github.com/Vaa3D/vaa3d_tools/blob/master/hackathon/mBrainAligner/docs/images_swc_reg/image-20210805143056992.png)

Registration of neuron reconstructions is important for comparative studies across cell-types and samples. Here, we introduce a step-by-step manual for registration of reconstruction data, in SWC format. You will need the deformation field files generated by the “brain image registration” step.



#### Step 1: collect the deformation field files. (See Appendix for detailed meaning of folders and files)

###### 1.1    Copy an empty set of folders from “GitHub directory” to \<your working directory> and name it by the brain ID. The structure of this folder set is shown below:

![swc_reg_example_2](https://github.com/Vaa3D/vaa3d_tools/blob/master/hackathon/mBrainAligner/docs/images_swc_reg/image-20210805123458726.png)

​	Structure of the "second_affine" folder:

![swc_reg_example_3](https://github.com/Vaa3D/vaa3d_tools/blob/master/hackathon/mBrainAligner/docs/images_swc_reg/image-20210805125109116.png)


​	Structure of the "third_warp_swc" folder:

![swc_reg_example_4](https://github.com/Vaa3D/vaa3d_tools/blob/master/hackathon/mBrainAligner/docs/images_swc_reg/image-20210805133906546.png)



###### 1.2    Find files for “second_affine” from the output of "stripremove", "global registration and  normalization" steps. 

​	1.2.1 Copy the output of "stripremove" (<brain_id>_stripremove.v3draw) to "second_affine\stripMove". 

​	1.2.2 Copy the output of "global registration and  normalization" (<brain_id>_stripremove_sub.marker) to "second_affine\Manual_marker\".

​	1.2.3 Copy the output of "global registration and  normalization" (<brain_id>_stripremove_tar.marker) to "second_affine\CCF_marker\".



###### 1.3  Find files for “third_warp_swc” from the output of "global registration and  normalization" and "brain registration" steps.

​	1.3.1 Copy the output of "global registration and  normalization" (<brain_id>_strpremove_global.v3draw) to "third_warp_swc\\affined_brain".

​	1.3.2 Copy the output of "global registration and  normalization" (<brain_id>_stripremove_norm.v3draw) to "third_warp_swc\\affined_norm_brain".

​	1.3.3 Copy the output of "brain registration" (tar.marker) to "third_warp_swc\\CCF_auto_marker", and rename it as "<brain_id>_tar.marker".

​	1.3.4 Copy the output of "brain registration" (sub.marker) to "third_warp_swc\\brain_auto_marker", and rename it as "<brain_id>_sub.marker".



###### 1.4  Fill in the initial and downsample brain pixel sizes in "\<your working directory\\brain_registration.xlsx>". 

![swc_reg_example_5](https://github.com/Vaa3D/vaa3d_tools/blob/master/hackathon/mBrainAligner/docs/images_swc_reg/image-20210805155002558.png)

#### Step 2: SWC registration.

###### 2.1 Input

Create a folder named "<brain_id>"  under \<your working directory>, and  copy your unregistered SWC files

to "<brain_id>".

###### 2.2 Run commands

open terminal in windows, and run the following commands:

```
cd <your working directory>
python Final_swc_wrap.py <your working directory>
```

###### 2.3 Output

The registered SWC files will saved under folder \<your working directory\\dest>. 



#### Appendix

Two directories (second_affine, third_warp_swc) are used to store your previous brain registration results. "average_template_25_u8_xpad.v3draw" is an Allen CCF brain, and "brain_registration.xlsx" is a table recording mouse brain downsample scale which you should record your target mouse brain downsample scale same as our example, and a python script, "Final_swc_wrap.py" is used to start the pipeline. The files are provided by us.  

```
pipeline-registration
.
├── second_affine
│   ├── CCF_marker
│   │   ├── 17052_stripremove_tar.marker
│   │   ├── ......
│   │   ├── <brain_id>_stripremove_tar.marker
│   │   ├── ......
│   │   └── 17304_strpremove_tar.marker
|	|
│   ├── Manual_marker
│   │   ├── 17052_stripremove_sub.marker
│   │   ├── ......
│   │   ├── <brain_id>_stripremove_sub.marker
│   │   ├── ......
│   │   └── 17304_strpremove_sub.marker
|	|
|   ├── stripMove
│   │   ├── 17052_stripremove.v3draw
│   │   ├── ......
│   │   ├── <brain_id>_stripremove.v3draw
│   │   ├── ......
│   │   └── 17304_stripremove.v3draw
|	|
|   ├── QtCore4.dll
|   ├── QtGui4.dll
│   └── main_warp_from_affine.exe
|	
├── third_warp_swc
│   ├── affined_brain
│   │   ├── 17052_stripremove_global.v3draw
│   │   ├── ......
│   │   ├── <brain_id>_strpremove_global.v3draw
│   │   ├── ......
│   │   └── 17304_strpremove_global.v3draw
|	|
│   ├── affined_norm_brain
│   │   ├── 17052_stripremove_norm.v3draw
│   │   ├── ......
│   │   ├── <brain_id>_stripremove_norm.v3draw
│   │   ├── ......
│   │   └── 17304_strpremove_norm.v3draw
|	|
|   ├── brain_auto_marker
│   │   ├── 17052_sub.marker
│   │   ├── ......
│   │   ├── <brain_id>_sub.marker
│   │   ├── ......
│   │   └── 17304_sub.marker
|	|
|   ├── CCF_auto_marker
│   │   ├── 17052_tar.marker
│   │   ├── ......
│   │   ├── <brain_id>_tar.marker
│   │   ├── ......
│   │   └── 17304_tar.marker
|	|
|   ├── QtCore4.dll
|   ├── QtGui4.dll
│   └── main_warp_from_df.exe
|	
├── average_template_25_u8_xpad.v3draw
|	
├── brain_registration.xlsx
|	
└── Final_swc_wrap.py
```

